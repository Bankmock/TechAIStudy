<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      background-color: #f4f4f4;
    }
    .video-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .button {
      background-color: #007bff;
      color: white;
      text-decoration: none;
      padding: 10px 14px;
      border-radius: 5px;
      display: inline-block;
      margin-top: 10px;
      cursor: pointer;
    }
    .button:hover {
      background-color: #0056b3;
    }
    video {
      width: 100%;
      border-radius: 5px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h2>{{ title }}</h2>

{% if thumbnail %}
  <img src="{{ thumbnail }}" alt="Thumbnail" style="max-width: 100%; border-radius: 8px;">
{% endif %}

<h3>Select format to preview or download:</h3>

{% for fmt in formats %}
  <div class="video-card">
    <div>
      <strong>{{ fmt.resolution }}</strong> | {{ fmt.ext }}
      {% if fmt.filesize %}
        | {{ (fmt.filesize / (1024*1024)) | round(2) }} MB
      {% endif %}
      <span class="download-wrapper" data-url="{{ fmt.url }}" data-name="video_{{ fmt.resolution }}.{{ fmt.ext }}">
        <!-- This span will be replaced by the button unless it's a YouTube URL -->
      </span>
    </div>

    <video controls preload="metadata">
      <source src="{{ fmt.url }}" type="video/{{ fmt.ext }}">
      Your browser does not support the video tag.
    </video>

    <p>Right-click to Save - <span style='font-size:30px;'>&#8285;</span></p>
    <br><small>(Browser may block auto-download from some sites)</small>
  </div>
{% endfor %}

<a href="/" style="margin-top: 20px; display: inline-block;">â¬… Back to Home</a>

<!-- JS to handle download buttons -->
<script>
function downloadDirect(videoUrl, filename) {
  fetch(videoUrl, { mode: 'cors' })
    .then(res => res.blob())
    .then(blob => {
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      window.URL.revokeObjectURL(link.href);
    })
    .catch(error => {
      alert("Download failed. This video may be protected or CORS-restricted.");
      console.error("Error:", error);
    });
}

// Insert download buttons unless the URL is from YouTube
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".download-wrapper").forEach(wrapper => {
    const url = wrapper.getAttribute("data-url");
    const name = wrapper.getAttribute("data-name");

    if (url.includes("youtube.com") || url.includes("googlevideo.com")) {
      wrapper.innerHTML = "<span style='color:red;'>Click 3 dot from video check audio + available to download Sign </span>";
    } else {
      wrapper.innerHTML = `<button class="button" onclick="downloadDirect('${url}', '${name}')">Download</button>`;
    }
  });
});
</script>

</body>
</html>