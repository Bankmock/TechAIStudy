<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ title }}</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 30px; }
    img { max-width: 300px; }
    .download-btn {
      background: green;
      color: white;
      padding: 10px 20px;
      margin: 8px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin-top: 15px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.2s ease;
    }
    .close-btn {
      background-color: red;
      color: white;
      border: none;
      padding: 6px 12px;
      margin-top: 15px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>{{ title }}</h1>
  <img src="{{ thumbnail }}" alt="Thumbnail">
  <h2>Select Format</h2>

  <div id="formats">
    {% for format in formats %}
      <button class="download-btn"
        onclick="startDownload('/stream?url={{ format.url | urlencode }}&filename={{ title }}.{{ format.ext }}', '{{ title }}.{{ format.ext }}')">Download - 
        {{ format.resolution }} ({{ format.ext }})
        {% if format.filesize %} - {{ (format.filesize / (1024*1024))|round(2) }}MB {% endif %}
        {% if not format.has_audio %} (No Audio) {% endif %}
      </button>
    {% endfor %}

    {% if audio_url %}
    <button class="download-btn"
      onclick="startDownload('/stream?url={{ audio_url | urlencode }}&filename={{ title }}.mmp3', '{{ title }}.mp3')">
      Download - Best Audio (MP3)
    </button>
    {% endif %}
  </div>

  <!-- Modal -->
  <div class="modal" id="downloadModal">
    <div class="modal-content">
      <h3>Download Progress</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <p id="download-status">Starting...</p>
      <button class="close-btn" onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    function openModal() {
      document.getElementById("downloadModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("downloadModal").style.display = "none";
    }

    async function startDownload(proxyUrl, filename) {
      const progressFill = document.getElementById("progress-fill");
      const downloadStatus = document.getElementById("download-status");

      openModal();
      progressFill.style.width = "0%";
      downloadStatus.innerText = "Downloading...";

      try {
        const res = await fetch(proxyUrl);

        if (!res.ok) {
          downloadStatus.innerText = "❌ Download failed.";
          return;
        }

        const contentLength = res.headers.get("Content-Length");
        const total = contentLength ? parseInt(contentLength, 10) : null;
        const reader = res.body.getReader();
        let received = 0;
        const chunks = [];

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          chunks.push(value);
          received += value.length;

          if (total) {
            const percent = Math.round((received / total) * 100);
            progressFill.style.width = percent + "%";
            downloadStatus.innerText = `Downloading... ${percent}%`;
          } else {
            progressFill.style.width = "100%";
            downloadStatus.innerText = `Downloading...`;
          }
        }

        const blob = new Blob(chunks);
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = blobUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(blobUrl);

        downloadStatus.innerText = "✅ Download complete!";
      } catch (err) {
        downloadStatus.innerText = "❌ Error: " + err.message;
      }
    }
  </script>
</body>
</html>