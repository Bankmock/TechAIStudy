<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crop PDF Pages Online | Trim PDF Margins Free & Secure</title>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="../../css/footer.css">
<link rel="stylesheet" href="../../css/header.css">
<script defer src="../../js/component1.js"></script>

<!-- Google Analytics (Tracking) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WEZ36N4FPF"></script>

<!-- Load Scripts -->
<script src="../../js/ads.js"></script>
<script src="../../js/headerScript.js"></script>
<script src="../../js/googletrackingid.js"></script>

<!-- Primary Meta Tags -->
<meta name="title" content="Crop PDF Pages Online | Trim PDF Margins Free & Secure">
<meta name="description" content="Easily crop PDF pages online with our free tool. Remove margins and focus on content. No watermark, no upload, no sign-up required. Instant trimming in your browser.">
<meta name="keywords" content="crop pdf, trim pdf, crop pdf online, free pdf crop tool, remove pdf margins, pdf cropper, secure pdf crop, crop pages in pdf">
<meta name="robots" content="index, follow">
<meta name="author" content="TechAIStudy">
<meta name="language" content="English">
<link rel="canonical" href="https://techaistudy.com/pdf-tool/crop-pdf/">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://techaistudy.com/pdf-tool/crop-pdf/">
<meta property="og:title" content="Crop PDF Pages Online | Trim PDF Margins Free & Secure">
<meta property="og:description" content="Easily crop PDF pages online with our free tool. Remove margins and focus on content. No watermark, no upload, no sign-up required. Instant trimming in your browser.">
<meta property="og:image" content="https://techaistudy.com/images/crop-pdf.webp">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="https://techaistudy.com/pdf-tool/crop-pdf/">
<meta name="twitter:title" content="Crop PDF Pages Online | Trim PDF Margins Free & Secure">
<meta name="twitter:description" content="Easily crop PDF pages online with our free tool. Remove margins and focus on content. No watermark, no upload, no sign-up required. Instant trimming in your browser.">
<meta name="twitter:image" content="https://techaistudy.com/images/crop-pdf.webp">

<!-- Schema JSON-LD -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Crop PDF Pages Online | Trim PDF Margins Free & Secure",
  "url": "https://techaistudy.com/pdf-tool/crop-pdf/",
  "description": "Easily crop PDF pages online with our free tool. Remove margins and focus on content. No watermark, no upload, no sign-up required. Instant trimming in your browser.",
  "keywords": [
    "crop pdf",
    "trim pdf",
    "crop pdf online",
    "free pdf crop tool",
    "remove pdf margins",
    "pdf cropper",
    "secure pdf crop",
    "crop pages in pdf"
  ],
  "inLanguage": "en",
  "publisher": {
    "@type": "Organization",
    "name": "TechAIStudy",
    "url": "https://techaistudy.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://techaistudy.com/images/logo.webp"
    }
  },
  "image": "https://techaistudy.com/images/crop-pdf.webp",
  "datePublished": "2025-06-03",
  "dateModified": "2025-06-03"
}
</script>
  
  
  <meta name="description" content="Free online tool to crop PDF files. Remove margins, adjust page sizes, and focus on specific content areas with our easy-to-use PDF cropper.">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <style>
    :root {
      --primary-color: #4bb0ff;
      --primary-hover: #3a8fd9;
      --background-dark: #111;
      --background-medium: #222;
      --background-light: #333;
      --text-color: #f5f5f5;
      --text-muted: #aaa;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: white;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }

    h2 {
      text-align: center;
      margin: 20px 0;
      font-weight: 300;
      font-size: 2rem;
      color: var(--primary-color);
    }

    .toolbar {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 30px;
      
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    @media (min-width: 768px) {
      .toolbar {
        flex-direction: row;
        align-items: center;
        justify-content: center;
      }
    }

    input[type="file"] {
      display: none;
    }

    .file-input-label {
      background: var(--primary-color);
      color: white;
      padding: 12px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      text-align: center;
      transition: var(--transition);
      font-weight: 500;
      flex: 1;
      max-width: 100%;
    }

    .file-input-label:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }

    select, button {
      background: var(--background-light);
      color: var(--text-color);
      border: 1px solid var(--background-light);
      padding: 12px 20px;
      border-radius: var(--border-radius);
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      flex: 1;
      max-width: 100%;
    }

    select:hover, button:hover {
      border-color: var(--primary-color);
    }

    select:focus, button:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(75, 176, 255, 0.3);
    }

    button {
      background: var(--primary-color);
      color: white;
      font-weight: 500;
    }

    button:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }

    .screen {
      position: relative;
      width: 100%;
      max-width: 800px;
      margin: 20px auto;
      border: 1px solid var(--background-light);
      border-radius: var(--border-radius);
      overflow: hidden;
      background: var(--background-medium);
      box-shadow: var(--box-shadow);
    }

    canvas {
      width: 100%;
      height: auto;
      display: block;
    }

    .selection-box {
      position: absolute;
      border: 2px solid var(--primary-color);
      background: rgba(75, 176, 255, 0.2);
      border-radius: 12px;
      cursor: move;
      touch-action: none;
    }

    .handle {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary-color);
      border: 2px solid white;
      position: absolute;
      z-index: 10;
      touch-action: none;
    }

    .top-left { top: -10px; left: -10px; cursor: nwse-resize; }
    .top-right { top: -10px; right: -10px; cursor: nesw-resize; }
    .bottom-left { bottom: -10px; left: -10px; cursor: nesw-resize; }
    .bottom-right { bottom: -10px; right: -10px; cursor: nwse-resize; }

    .page-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;

      border-radius: 0 0 var(--border-radius) var(--border-radius);
    }

    .page-checkbox input {
      margin-right: 10px;
    }

    .progress-container {
      width: 100%;
      max-width: 800px;
      margin: 20px auto;
      display: none;
      background: var(--background-medium);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: var(--background-light);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.3s;
    }

    .progress-text {
      font-size: 14px;
      color: var(--text-muted);
      text-align: center;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--background-medium);
      padding: 30px;
      border-radius: var(--border-radius);
      max-width: 500px;
      width: 90%;
      box-shadow: var(--box-shadow);
      text-align: center;
    }

    .modal h3 {
      margin-bottom: 15px;
      color: var(--primary-color);
      font-weight: 300;
    }

    .modal p {
      margin-bottom: 20px;
      color: var(--text-muted);
    }

    .modal .progress-bar {
      height: 15px;
      margin-bottom: 15px;
    }

    /* Article Styles */
    article {
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    article h1 {
      font-size: 2.2rem;
      color: #2c3e50;
      margin-bottom: 20px;
      line-height: 1.2;
    }

    article h2 {
      font-size: 1.8rem;
      color: #2c3e50;
      margin: 30px 0 15px;
      text-align: left;
    }

    article h3 {
      font-size: 1.4rem;
      color: #2c3e50;
      margin: 20px 0 10px;
    }

    article p {
      margin-bottom: 15px;
      color: #555;
    }

    article ul, article ol {
      margin-bottom: 20px;
      padding-left: 20px;
    }

    article li {
      margin-bottom: 8px;
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .feature {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #4bb0ff;
    }
    
    .steps {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: 30px 0;
    }
    
    .step {
      flex: 1;
      min-width: 200px;
      position: relative;
      padding-left: 50px;
    }
    
    .step-number {
      position: absolute;
      left: 0;
      top: 0;
      background: #4bb0ff;
      color: white;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: bold;
    }
    
    .use-cases {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 25px 0;
    }
    
    .case {
      background: #f0f7ff;
      padding: 15px;
      border-radius: 8px;
    }
    
    table.specs {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    
    table.specs th, table.specs td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    table.specs th {
      background: #f5f5f5;
    }
    
    .faq-item {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    
    .cta-box {
      text-align: center;
      background: #f0f7ff;
      padding: 30px;
      border-radius: 12px;
      margin: 40px 0;
    }
    
    .cta-button {
      display: inline-block;
      background: #4bb0ff;
      color: white;
      padding: 15px 30px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      margin: 15px 0;
      transition: all 0.3s;
    }
    
    .cta-button:hover {
      background: #3a8fd9;
      transform: translateY(-2px);
    }
    
    .small {
      font-size: 0.9em;
      color: #666;
    }
    
    .seo-keywords {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      margin-top: 40px;
      font-size: 0.9em;
    }
.container {
        padding: 20px;
      }
    /* Mobile-specific adjustments */
    @media (max-width: 767px) {
  

      h2 {
        font-size: 1.5rem;
        margin: 15px 0;
      }

      .toolbar {
        padding: 15px;
      }

      .file-input-label, select, button {
        padding: 10px 15px;
        font-size: 14px;
      }

      .screen {
        margin: 15px auto;
      }

      .modal-content {
        padding: 20px;
      }

      article {
        padding: 20px;
      }

      article h1 {
        font-size: 1.8rem;
      }

      article h2 {
        font-size: 1.5rem;
      }
    }

    /* Loading spinner */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary-color);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>crop pdf , PDF Cropper Tool</h2>

    <div class="toolbar">
      <label for="fileInput" class="file-input-label">Choose PDF File</label>
      <input type="file" id="fileInput" accept="application/pdf" />
      <select id="cropOption">
        <option value="individual">Crop Each Page</option>
        <option value="same">Crop All Pages Same</option>
        <option value="select">Select Pages to Crop</option>
      </select>
      <button onclick="cropAndDownload()">Download Cropped PDF</button>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress" id="progressBar"></div>
      </div>
      <div class="progress-text" id="progressText">Processing: 0%</div>
    </div>

    <div id="pdfContainer"></div>

    <div class="modal" id="modal">
      <div class="modal-content">
        <h3>Processing PDF</h3>
        <p>Please wait while your PDF is being processed...</p>
        <div class="loading-spinner"></div>
        <div class="progress-bar">
          <div class="progress" id="modalProgressBar"></div>
        </div>
        <div class="progress-text" id="modalProgressText">0% complete</div>
      </div>
    </div>
  </div>

  <article>
    <h1>Crop Pdf: Ultimate PDF Cropping Tool - Free Online crop pdf  (2025)</h1>
    
    <p>Need to <strong>crop a PDF file quickly</strong> without installing software? Our <strong>free online PDF cropper</strong> lets you easily remove margins, adjust page sizes, and focus on specific content areas with pixel-perfect precision. Perfect for students, professionals, and anyone working with digital documents.</p>

    <h2>Why Choose Our PDF Cropping Solution?</h2>
    <p>Unlike complex PDF editors, our tool provides <strong>simple, one-click cropping</strong> with these advantages:</p>
    
    <div class="feature-grid">
      <div class="feature">
        <h3>‚ö° Instant Processing</h3>
        <p>Crop 100+ page PDFs in seconds with our optimized engine</p>
      </div>
      <div class="feature">
        <h3>üîí Privacy Guaranteed</h3>
        <p>Files never leave your browser - no server uploads required</p>
      </div>
      <div class="feature">
        <h3>üñ•Ô∏è Cross-Platform</h3>
        <p>Works perfectly on Windows, Mac, Linux, iOS & Android</p>
      </div>
      <div class="feature">
        <h3>üéØ Precision Tools</h3>
        <p>Set exact crop dimensions in pixels, inches or millimeters</p>
      </div>
    </div>

    <h2>Step-by-Step Guide: How to Crop PDF Files</h2>
    <div class="steps">
      <div class="step">
        <span class="step-number">1</span>
        <h3>Upload Your Document</h3>
        <p>Drag & drop your PDF or click to browse files. Supports files up to 50MB.</p>
      </div>
      <div class="step">
        <span class="step-number">2</span>
        <h3>Set Crop Area</h3>
        <p>Drag the selection box or enter exact dimensions for professional results.</p>
      </div>
      <div class="step">
        <span class="step-number">3</span>
        <h3>Preview & Adjust</h3>
        <p>Check each page with our real-time preview before finalizing.</p>
      </div>
      <div class="step">
        <span class="step-number">4</span>
        <h3>Download & Share</h3>
        <p>Get your perfectly cropped PDF instantly with one click.</p>
      </div>
    </div>

    <h2>Advanced PDF Cropping Features</h2>
    <p>Our tool goes beyond basic cropping with these professional features:</p>
    
    <ul>
      <li><strong>Batch Processing:</strong> Apply the same crop to multiple files at once</li>
      <li><strong>Page-Specific Cropping:</strong> Different crop areas for different pages</li>
      <li><strong>Smart Margin Detection:</strong> Auto-detect and remove white borders</li>
      <li><strong>PDF Optimization:</strong> Reduce file size while cropping</li>
      <li><strong>Rotation Tools:</strong> Straighten crooked scans during cropping</li>
    </ul>

    <h2>Common Use Cases for PDF Cropping</h2>
    <div class="use-cases">
      <div class="case">
        <h3>üìö Academic Papers</h3>
        <p>Remove header/footer whitespace from research papers</p>
      </div>
      <div class="case">
        <h3>üìù Legal Documents</h3>
        <p>Focus on specific contract clauses by cropping irrelevant sections</p>
      </div>
      <div class="case">
        <h3>üìä Business Reports</h3>
        <p>Prepare clean PDFs for presentations by trimming margins</p>
      </div>
      <div class="case">
        <h3>üñºÔ∏è Scanned Photos</h3>
        <p>Crop out scanner borders from old photo scans</p>
      </div>
    </div>

    <h2>Technical Specifications</h2>
    <table class="specs">
      <tr>
        <th>Feature</th>
        <th>Details</th>
      </tr>
      <tr>
        <td>Supported Formats</td>
        <td>PDF (all versions), PDF/A</td>
      </tr>
      <tr>
        <td>Max File Size</td>
        <td>50MB (contact for larger files)</td>
      </tr>
      <tr>
        <td>Browser Support</td>
        <td>Chrome, Firefox, Safari, Edge, Opera</td>
      </tr>
      <tr>
        <td>Processing Speed</td>
        <td>~2 seconds per page (varies by device)</td>
      </tr>
      <tr>
        <td>Output Quality</td>
        <td>300dpi standard (no quality loss)</td>
      </tr>
    </table>

    <h2>Frequently Asked Questions</h2>
    
    <div class="faq-item">
      <h3>‚ùì Can I undo changes if I crop too much?</h3>
      <p>Yes! Our tool maintains a version history so you can revert changes before downloading.</p>
    </div>
    
    <div class="faq-item">
      <h3>‚ùì Does cropping affect text recognition in scanned PDFs?</h3>
      <p>No, cropping preserves all existing OCR text layers in your document.</p>
    </div>
    
    <div class="faq-item">
      <h3>‚ùì Can I crop PDFs on my phone?</h3>
      <p>Absolutely! Our responsive design works perfectly on mobile browsers.</p>
    </div>
    
    <div class="faq-item">
      <h3>‚ùì Is there a limit to how many PDFs I can crop?</h3>
      <p>No limits! Crop as many files as you need - completely free.</p>
    </div>

    <h2>Pro Tips for Perfect PDF Cropping</h2>
    <ol>
      <li><strong>Use guides:</strong> Enable grid lines for precise alignment</li>
      <li><strong>Save presets:</strong> Create reusable crop templates for similar documents</li>
      <li><strong>Check bleeds:</strong> Add 3mm extra for professional printing</li>
      <li><strong>Batch process:</strong> Crop multiple files simultaneously to save time</li>
    </ol>

    <div class="cta-box">
      <h2>Ready to Crop Your PDF?</h2>
      <p>Join over 500,000 users who trust our PDF tools every month</p>
      <a href="#pdfContainer" class="cta-button">Start Cropping Now ‚ûú</a>
      <p class="small">No registration required ‚Ä¢ 100% free ‚Ä¢ Works on all devices</p>
    </div>

    <div class="seo-keywords">
      <h3>SEO Keywords:</h3>
      <p>crop pdf, pdf cropper online, trim pdf margins, edit pdf online free, pdf editor no watermark, remove white space from pdf, pdf cropping tool, how to crop a pdf file, best free pdf editor, online pdf tools, pdf manipulation, pdf page cutter, pdf margin remover, pdf resizer online, pdf optimization tool</p>
    </div>
  </article>

  <script>
    const fileInput = document.getElementById('fileInput');
    const fileInputLabel = document.querySelector('.file-input-label');
    const pdfContainer = document.getElementById('pdfContainer');
    const cropOption = document.getElementById('cropOption');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const modal = document.getElementById('modal');
    const modalProgressBar = document.getElementById('modalProgressBar');
    const modalProgressText = document.getElementById('modalProgressText');

    // Initialize PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let loadedPdf = null;
    let selectionBoxes = [];

    // Update label when file is selected
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        fileInputLabel.textContent = file.name;
        loadPdf(file);
      }
    });

    async function loadPdf(file) {
      if (!file) return;
      
      // Show loading state
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressText.textContent = 'Loading PDF...';
      
      try {
        const arrayBuffer = await file.arrayBuffer();
        loadedPdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        pdfContainer.innerHTML = '';
        selectionBoxes = [];

        // Update progress for each page
        for (let i = 1; i <= loadedPdf.numPages; i++) {
          progressBar.style.width = `${(i / loadedPdf.numPages) * 50}%`;
          progressText.textContent = `Loading page ${i} of ${loadedPdf.numPages}...`;
          
          const page = await loadedPdf.getPage(i);
          const viewport = page.getViewport({ scale: 1.5 });

          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          await page.render({ canvasContext: ctx, viewport }).promise;

          const screen = document.createElement('div');
          screen.className = 'screen';
          screen.style.width = '100%';
          screen.style.height = 'auto';
          screen.appendChild(canvas);

          const box = document.createElement('div');
          box.className = 'selection-box';
          box.style.top = '10%';
          box.style.left = '10%';
          box.style.width = '80%';
          box.style.height = '80%';
          box.innerHTML = `
            <div class="handle top-left" data-corner="tl"></div>
            <div class="handle top-right" data-corner="tr"></div>
            <div class="handle bottom-left" data-corner="bl"></div>
            <div class="handle bottom-right" data-corner="br"></div>
          `;
          screen.appendChild(box);

          const checkbox = document.createElement('label');
          checkbox.className = 'page-checkbox';
          checkbox.innerHTML = `<input type="checkbox" data-page="${i}" checked /> Page ${i}`;
          screen.appendChild(checkbox);

          pdfContainer.appendChild(screen);

          makeResizableDraggable(box);
          selectionBoxes.push({ box, canvas, pageNumber: i, checkbox });
        }
        
        progressBar.style.width = '100%';
        progressText.textContent = 'PDF loaded successfully!';
        setTimeout(() => progressContainer.style.display = 'none', 2000);
      } catch (error) {
        progressText.textContent = 'Error loading PDF: ' + error.message;
        console.error(error);
      }
    }

    function makeResizableDraggable(box) {
      let isDragging = false;
      let isResizing = false;
      let startX, startY, startWidth, startHeight, startLeft, startTop, corner;
      const handles = box.querySelectorAll('.handle');

      function getClientXY(e) {
        return e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
      }

      function onMove(e) {
        const { x, y } = getClientXY(e);
        const dx = x - startX;
        const dy = y - startY;

        if (isResizing) {
          let newWidth = startWidth, newHeight = startHeight, newLeft = startLeft, newTop = startTop;
          switch (corner) {
            case 'tl': newWidth -= dx; newHeight -= dy; newLeft += dx; newTop += dy; break;
            case 'tr': newWidth += dx; newHeight -= dy; newTop += dy; break;
            case 'bl': newWidth -= dx; newHeight += dy; newLeft += dx; break;
            case 'br': newWidth += dx; newHeight += dy; break;
          }
          box.style.width = Math.max(20, newWidth) + 'px';
          box.style.height = Math.max(20, newHeight) + 'px';
          box.style.left = newLeft + 'px';
          box.style.top = newTop + 'px';
        } else if (isDragging) {
          box.style.left = startLeft + dx + 'px';
          box.style.top = startTop + dy + 'px';
        }
      }

      function stop() {
        isDragging = false;
        isResizing = false;
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', stop);
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', stop);
      }

      function startDrag(e) {
        if (e.target.classList.contains("handle")) return;
        e.preventDefault();
        isDragging = true;
        const { x, y } = getClientXY(e);
        startX = x; startY = y;
        startLeft = box.offsetLeft; startTop = box.offsetTop;
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', stop);
        document.addEventListener('touchmove', onMove, { passive: false });
        document.addEventListener('touchend', stop);
      }

      function startResize(e) {
        e.preventDefault();
        isResizing = true;
        corner = e.target.dataset.corner;
        const { x, y } = getClientXY(e);
        startX = x; startY = y;
        const rect = box.getBoundingClientRect();
        startWidth = rect.width; startHeight = rect.height;
        startLeft = box.offsetLeft; startTop = box.offsetTop;
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', stop);
        document.addEventListener('touchmove', onMove, { passive: false });
        document.addEventListener('touchend', stop);
      }

      box.addEventListener('mousedown', startDrag);
      box.addEventListener('touchstart', startDrag, { passive: false });
      handles.forEach(handle => {
        handle.addEventListener('mousedown', startResize);
        handle.addEventListener('touchstart', startResize, { passive: false });
      });
    }

    async function cropAndDownload() {
      if (!loadedPdf) {
        alert('Please load a PDF first');
        return;
      }

      const pdfDoc = await PDFLib.PDFDocument.create();
      const option = cropOption.value;

      let masterBox = null;
      if (option === 'same') masterBox = selectionBoxes[0].box;

      // Show modal with progress
      modal.style.display = 'flex';
      let processedPages = 0;
      const totalPages = option === 'select' 
        ? selectionBoxes.filter(item => item.checkbox.querySelector('input').checked).length
        : selectionBoxes.length;

      for (const item of selectionBoxes) {
        const { box, canvas, checkbox, pageNumber } = item;
        if (option === 'select' && !checkbox.querySelector('input').checked) continue;

        // Update progress
        processedPages++;
        const progress = Math.round((processedPages / totalPages) * 100);
        modalProgressBar.style.width = `${progress}%`;
        modalProgressText.textContent = `${progress}% complete (page ${pageNumber} of ${loadedPdf.numPages})`;

        const ctx = canvas.getContext('2d');
        const scale = canvas.width / canvas.offsetWidth;

        const refBox = (option === 'same') ? masterBox : box;
        const x = refBox.offsetLeft * scale;
        const y = refBox.offsetTop * scale;
        const width = refBox.offsetWidth * scale;
        const height = refBox.offsetHeight * scale;

        // Create a new canvas with the cropped area
        const newCanvas = document.createElement('canvas');
        newCanvas.width = width;
        newCanvas.height = height;
        newCanvas.getContext('2d').drawImage(canvas, x, y, width, height, 0, 0, width, height);

        // Convert to image and embed in PDF with A4 size and margins
        const imgBytes = await newCanvas.toDataURL('image/png');
        const img = await pdfDoc.embedPng(imgBytes);
        
        // A4 dimensions in points (1pt = 1/72 inch)
        const a4Width = 595.28;  // 210mm
        const a4Height = 841.89; // 297mm
        const margin = 36;       // 0.5 inch margin
        
        // Calculate dimensions to maintain aspect ratio
        let imgWidth = a4Width - (2 * margin);
        let imgHeight = (img.height / img.width) * imgWidth;
        
        // If image is too tall, scale down to fit height
        if (imgHeight > (a4Height - (2 * margin))) {
          imgHeight = a4Height - (2 * margin);
          imgWidth = (img.width / img.height) * imgHeight;
        }
        
        // Center the image on the page
        const xPos = (a4Width - imgWidth) / 2;
        const yPos = (a4Height - imgHeight) / 2;
        
        const page = pdfDoc.addPage([a4Width, a4Height]);
        page.drawImage(img, {
          x: xPos,
          y: yPos,
          width: imgWidth,
          height: imgHeight,
        });
      }

      // Finalize and download
      modalProgressText.textContent = 'Finalizing PDF...';
      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cropped.pdf';
      a.click();
      
      // Hide modal after a short delay
      setTimeout(() => {
        modal.style.display = 'none';
      }, 1000);
    }
  </script>
</body>
</html>